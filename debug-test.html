<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DyslexiaAssist - API Debug Test</title>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background: #f0fffe;
            color: #333;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-card {
            background: white;
            border-left: 4px solid #2d5a56;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .btn {
            background: #2d5a56;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover {
            background: #1a4d4a;
        }
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .result {
            margin-top: 15px;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 14px;
            white-space: pre-wrap;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #e8f7f5; color: #2d5a56; }
        input[type="password"] {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .warning { color: #ffc107; }
        .info { color: #17a2b8; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        #console-output {
            background: #1e1e1e;
            color: #fff;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>DyslexiaAssist Extension Debug Test</h1>
    
    <div class="test-section">
        <h3>Extension Loading Test</h3>
        <p>This page will help you debug why the AI features aren't working.</p>
        <button onclick="runFullTest()">Run Full Test</button>
        <button onclick="testExtensionBasics()">Test Extension Basics</button>
        <button onclick="testAIModules()">Test AI Modules</button>
        <button onclick="testAPIKey()">Test API Key</button>
        <button onclick="clearConsole()">Clear Log</button>
    </div>

    <div class="test-section">
        <h3>Console Output</h3>
        <div id="console-output">Click "Run Full Test" to start debugging...\n</div>
    </div>

    <div class="test-section">
        <h3>Instructions</h3>
        <ol>
            <li>Make sure the DyslexiaAssist extension is loaded in Chrome</li>
            <li>Open Chrome DevTools (F12) to see detailed error messages</li>
            <li>Click "Run Full Test" to check all functionality</li>
            <li>Look for specific error messages in the log above</li>
        </ol>
    </div>

    <script>
        const output = document.getElementById('console-output');
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type.toUpperCase();
            const line = `[${timestamp}] ${prefix}: ${message}\n`;
            output.textContent += line;
            output.scrollTop = output.scrollHeight;
        }

        function clearConsole() {
            output.textContent = '';
        }

        async function runFullTest() {
            clearConsole();
            log('Starting full DyslexiaAssist test...', 'info');
            
            await testExtensionBasics();
            await testAPIKey();
            await testAIModules();
            
            log('Full test completed!', 'info');
        }

        async function testExtensionBasics() {
            log('Testing extension basics...', 'info');
            
            // Test Chrome APIs
            if (typeof chrome === 'undefined') {
                log('Chrome extension APIs not available', 'error');
                return false;
            }
            log('✓ Chrome APIs available', 'success');

            // Test storage
            try {
                await chrome.storage.sync.set({test: 'debugging'});
                const result = await chrome.storage.sync.get(['test']);
                if (result.test === 'debugging') {
                    log('✓ Chrome storage working', 'success');
                } else {
                    log('✗ Chrome storage test failed', 'error');
                }
            } catch (error) {
                log('✗ Chrome storage error: ' + error.message, 'error');
            }

            // Test tabs API
            try {
                const tabs = await chrome.tabs.query({active: true, currentWindow: true});
                if (tabs && tabs.length > 0) {
                    log('✓ Active tab accessible', 'success');
                } else {
                    log('✗ No active tab found', 'error');
                }
            } catch (error) {
                log('✗ Tabs API error: ' + error.message, 'error');
            }

            return true;
        }

        async function testAPIKey() {
            log('Testing API key configuration...', 'info');
            
            try {
                const result = await chrome.storage.sync.get(['google-ai-key']);
                if (result['google-ai-key']) {
                    const keyPreview = result['google-ai-key'].substring(0, 10) + '...';
                    log(`✓ API key configured: ${keyPreview}`, 'success');
                    return true;
                } else {
                    log('✗ API key not configured', 'error');
                    log('Please go to extension options and set your Google AI Studio API key', 'warning');
                    return false;
                }
            } catch (error) {
                log('✗ Error checking API key: ' + error.message, 'error');
                return false;
            }
        }

        async function testAIModules() {
            log('Testing AI modules loading...', 'info');
            
            try {
                const tabs = await chrome.tabs.query({active: true, currentWindow: true});
                if (!tabs[0]) {
                    log('✗ No active tab for testing', 'error');
                    return false;
                }

                log('Pinging content script...', 'info');
                const pingResponse = await chrome.tabs.sendMessage(tabs[0].id, {action: 'ping'});
                if (pingResponse && pingResponse.success) {
                    log('✓ Content script responding', 'success');
                } else {
                    log('✗ Content script not responding', 'error');
                    return false;
                }

                log('Testing AI features...', 'info');
                const aiResponse = await chrome.tabs.sendMessage(tabs[0].id, {action: 'testAI'});
                if (aiResponse && aiResponse.success && aiResponse.aiStatus) {
                    const status = aiResponse.aiStatus;
                    log('AI Status received:', 'info');
                    log(`  - AI Processing Enabled: ${status.aiProcessingEnabled}`, status.aiProcessingEnabled ? 'success' : 'error');
                    log(`  - TextProcessor: ${status.textProcessor}`, status.textProcessor ? 'success' : 'error');
                    log(`  - SpeechProcessor: ${status.speechProcessor}`, status.speechProcessor ? 'success' : 'warning');
                    log(`  - PersonalizationEngine: ${status.personalizationEngine}`, status.personalizationEngine ? 'success' : 'warning');
                    log(`  - AdvancedAI: ${status.advancedAI}`, status.advancedAI ? 'success' : 'error');
                    
                    log('Class availability:', 'info');
                    Object.entries(status.classes).forEach(([className, available]) => {
                        log(`  - ${className}: ${available}`, available ? 'success' : 'error');
                    });
                    
                    if (status.aiProcessingEnabled && status.textProcessor && status.advancedAI) {
                        log('✓ AI features fully functional!', 'success');
                        return true;
                    } else {
                        log('⚠ AI features partially loaded', 'warning');
                        return false;
                    }
                } else {
                    log('✗ Could not get AI status from content script', 'error');
                    return false;
                }
            } catch (error) {
                log('✗ Error testing AI modules: ' + error.message, 'error');
                return false;
            }
        }
    </script>
</body>
</html>